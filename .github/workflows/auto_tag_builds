name: auto tag builds

on:
  push:
    branches:
      - test/versioning
    paths:
      - '**/version.properties'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find version.properties path and extract folder name
      id: get_folder
      run: |
        file_path=$(find . -type f -name version.properties | head -n 1)
        folder_name=$(basename $(dirname "$file_path"))
        echo "folder=$folder_name" >> $GITHUB_OUTPUT
        echo "file_path=$file_path" >> $GITHUB_OUTPUT

    - name: Read version from version.properties
      id: get_version
      run: |
        version=$(grep '^version:' "${{ steps.get_folder.outputs.file_path }}" | cut -d':' -f2 | xargs)
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Create tag
      run: |
        tag_name="${{ steps.get_folder.outputs.folder }}_${{ steps.get_version.outputs.version }}"
        git config user.name 'GitHub Auto Merge Action'
        git config user.email 'actions@github.com'
        git tag "$tag_name"
        git push origin "$tag_name"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
